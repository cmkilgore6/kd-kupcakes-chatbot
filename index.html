<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K's Kupcakes Admin Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f7f9fb; 
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .lead-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .lead-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
        <h1 class="text-4xl font-extrabold mb-2 text-center text-rose-700">
            üßÅ Lead Management Dashboard
        </h1>
        <p class="text-center text-gray-500 mb-6 border-b pb-4">
            Real-time custom order requests from Sprinkles Chatbot.
        </p>

        <!-- Loading/Error Indicator -->
        <div id="status-message" class="mb-4 p-3 bg-blue-100 text-blue-800 rounded-lg text-sm" role="alert">
            Connecting to database...
        </div>
        
        <!-- Permanent Error Warning Block (Only hidden on successful data load) -->
        <div id="security-warning" class="hidden">
            <div class="p-6 my-4 bg-red-900 text-white rounded-xl shadow-xl border-4 border-red-500">
                <h3 class="text-2xl font-bold mb-3">üõë CRITICAL: PERMISSIONS BLOCKING DATA</h3>
                <p class="mb-4">The code is running correctly, but your **Firebase Security Rules are blocking access**.</p>
                <p class="font-semibold mb-2">To fix this, you MUST:</p>
                <ol class="list-decimal list-inside space-y-1 ml-4">
                    <li>Go to your **Firebase Console**.</li>
                    <li>Navigate to **Firestore Database** > **Rules**.</li>
                    <li>Ensure the following rule is present for the public data path:</li>
                </ol>
                <pre class="bg-black/40 p-3 mt-3 rounded-lg text-sm select-all">
match /artifacts/{appId}/public/data/orders/{orderId} {
  allow read, create, update: if request.auth != null;
  allow delete: if false; 
}</pre>
                <p class="mt-4 text-yellow-300 font-bold">4. Click the blue **PUBLISH** button in the Firebase Rules tab.</p>
                <p class="text-xs mt-2">The Dashboard will load immediately after the rules are published.</p>
            </div>
        </div>

        <!-- Leads Container -->
        <div id="leads-container" class="space-y-4 hidden">
            <!-- Lead cards will be dynamically inserted here -->
            <p id="no-leads" class="text-center text-gray-400 p-8 hidden">
                üéâ All leads processed! Go bake some dreams!
            </p>
        </div>
    </div>

    <script type="module">
        // --- FIREBASE SETUP ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, updateDoc, serverTimestamp, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Enable debug logging for Firestore
        setLogLevel('debug');

        // Use the global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- MANUAL CONFIGURATION REQUIRED FOR EXTERNAL DEPLOYMENT ---
        // NOTE: These MUST match the values used in client_chatbot.html
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA4DRHNH-ebn_z6zolcLLkZctTKD9HbPyY", 
            authDomain: "kskupcakeleads.firebaseapp.com",
            projectId: "kskupcakeleads",
            storageBucket: "kskupcakeleads.firebasestorage.app",
            messagingSenderId: "979562316466",
            appId: "1:979562316466:web:7b07802098ec504623ffab" 
        };
        // --- END: MANUAL CONFIGURATION ---

        let firebaseConfig = MANUAL_FIREBASE_CONFIG;

        // Check for Canvas environment configuration override
        if (typeof __firebase_config !== 'undefined' && JSON.stringify(__firebase_config) !== '{}') {
            firebaseConfig = JSON.parse(__firebase_config);
        }

        // Configuration check
        if (!firebaseConfig || !firebaseConfig.apiKey) {
            document.getElementById('status-message').className = 'mb-4 p-3 bg-red-100 text-red-800 rounded-lg text-sm block';
            document.getElementById('status-message').textContent = 'Error: Firebase configuration is missing or incomplete. Cannot connect to the database.';
            throw new Error("Firebase Configuration Incomplete.");
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const statusMessage = document.getElementById('status-message');
        const leadsContainer = document.getElementById('leads-container');
        const noLeadsMessage = document.getElementById('no-leads');
        const securityWarning = document.getElementById('security-warning');
        securityWarning.classList.remove('hidden'); 
        leadsContainer.classList.add('hidden'); 

        let isAuthReady = false;
        let currentUserId = null;

        /**
         * Signs in the user anonymously if no custom token is provided.
         */
        async function authenticate() {
             statusMessage.classList.remove('hidden');
             statusMessage.textContent = 'Authenticating...';
             
             try {
                // The client chatbot is using Anonymous auth, so the dashboard should too.
                await signInAnonymously(auth);
             } catch (error) {
                 console.error("Anonymous authentication failed:", error);
                 statusMessage.className = 'mb-4 p-3 bg-red-100 text-red-800 rounded-lg text-sm block';
                 statusMessage.textContent = `Authentication Error: ${error.message}. Ensure Anonymous Sign-in is enabled.`;
                 isAuthReady = false;
                 return;
             }
        }

        /**
         * Starts the real-time listener for the leads collection.
         */
        function startLeadListener() {
            if (!isAuthReady) {
                console.warn("Authentication not ready. Skipping lead listener start.");
                return;
            }

            // Public data path: /artifacts/{appId}/public/data/orders
            const collectionPath = `artifacts/${appId}/public/data/orders`; // The path being queried
            console.log("Attempting to listen to collection:", collectionPath);
            
            const ordersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
            // Query to fetch all orders
            const q = query(ordersCollectionRef);

            statusMessage.textContent = 'Listening for new leads...';

            // Real-time listener
            onSnapshot(q, (snapshot) => {
                let leads = [];
                snapshot.forEach(doc => {
                    leads.push({ id: doc.id, ...doc.data() });
                });

                // HIDE ERROR MESSAGES ON SUCCESS
                securityWarning.classList.add('hidden'); 
                leadsContainer.classList.remove('hidden');

                // In-memory sort: Newest leads first
                leads.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                renderLeads(leads);
            }, (error) => {
                console.error("Error listening to leads:", error);
                // On permission error, display the strong warning and keep status message updated
                securityWarning.classList.remove('hidden');
                leadsContainer.classList.add('hidden');
                statusMessage.className = 'mb-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg text-sm block';
                // Display the specific path that failed to help the user debug their rules
                statusMessage.textContent = `ERROR: Database Connection Blocked. Check Security Rules (see critical warning below). Failed Path: ${collectionPath}`;
            });
        }

        /**
         * Renders the lead cards in the UI.
         * @param {Array} leads - Array of lead objects from Firestore.
         */
        function renderLeads(leads) {
            leadsContainer.innerHTML = ''; // Clear existing leads
            statusMessage.classList.add('hidden'); // Hide status once data is received
            
            // Filter for only 'New Lead' status to display in the main dashboard
            const newLeads = leads.filter(lead => lead.status === 'New Lead');

            if (newLeads.length === 0) {
                noLeadsMessage.classList.remove('hidden');
                return;
            } else {
                noLeadsMessage.classList.add('hidden');
            }

            newLeads.forEach(lead => {
                const date = lead.timestamp ? new Date(lead.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                const card = document.createElement('div');
                card.className = `lead-card bg-white border border-gray-200 p-5 rounded-lg shadow-md flex justify-between items-start`;
                
                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-xl font-bold text-rose-600">New Custom Order Request</h2>
                            <span class="text-sm font-medium text-gray-500">${date}</span>
                        </div>
                        <p class="text-sm font-semibold text-gray-700 mt-1">
                            <span class="font-normal text-gray-500">Step 1:</span> ${lead.step1_details || 'No details provided.'}
                        </p>
                        <p class="text-sm font-semibold text-gray-700 mt-1">
                            <span class="font-normal text-gray-500">Step 2:</span> ${lead.step2_details || 'No details provided.'}
                        </p>
                        <small class="text-xs text-gray-400 mt-2 block">Client ID: ${lead.client_id || 'N/A'}</small>
                    </div>
                    <div class="ml-4 flex-shrink-0">
                        <button data-lead-id="${lead.id}" 
                                class="mark-contacted-btn bg-green-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-600 transition duration-150 shadow-md whitespace-nowrap">
                            Mark Contacted
                        </button>
                    </div>
                `;
                leadsContainer.appendChild(card);
            });

            // Attach event listeners to the new buttons
            document.querySelectorAll('.mark-contacted-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const leadId = e.target.dataset.leadId;
                    updateLeadStatus(leadId, 'Contacted');
                });
            });
        }

        /**
         * Updates the status of a lead document in Firestore.
         * @param {string} leadId - The ID of the document to update.
         * @param {string} newStatus - The new status (e.g., 'Contacted').
         */
        async function updateLeadStatus(leadId, newStatus) {
            if (!isAuthReady) {
                console.error("Cannot update lead: Authentication not complete.");
                return;
            }

            const button = document.querySelector(`[data-lead-id="${leadId}"]`);
            if (button) button.disabled = true;

            try {
                const leadRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', leadId);
                await updateDoc(leadRef, {
                    status: newStatus,
                    contacted_by: currentUserId,
                    contacted_at: serverTimestamp()
                });
                console.log(`Lead ${leadId} updated to ${newStatus}.`);
            } catch (e) {
                console.error("Error updating lead status (Permissions likely):", e);
                // Simple error notification
                const errorDiv = document.createElement('div');
                errorDiv.className = 'p-2 mt-2 bg-red-100 text-red-800 rounded-md text-xs';
                errorDiv.textContent = `Update Failed: ${e.code || e.message}. Did you publish the 'update' rule?`;
                leadsContainer.prepend(errorDiv);
                if (button) button.disabled = false;
                setTimeout(() => errorDiv.remove(), 5000); // Remove after 5 seconds
            }
        }

        // --- Main Execution ---
        
        // Use onAuthStateChanged to ensure we only start listening AFTER authentication
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                isAuthReady = true;
                statusMessage.className = 'mb-4 p-3 bg-green-100 text-green-800 rounded-lg text-sm block';
                statusMessage.textContent = `Successfully connected as user: ${currentUserId}`;
                console.log(`User is signed in. UID: ${currentUserId}`);
                startLeadListener();
            } else {
                // User is signed out or initial check failed, attempt to sign in anonymously
                authenticate();
            }
        });

    </script>
</body>
</html>
